# ç«¶è¼ªäºˆæƒ³Bot v2.0 - æœã®ã‚¸ãƒ§ãƒ–
# ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»äºˆæƒ³ç”Ÿæˆãƒ»LINEé…ä¿¡

name: ğŸŒ… Morning - Prediction

on:
  # æ¯æ—¥ JST 9:00 (UTC 0:00) ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆActionsã‚¿ãƒ–ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ï¼‰
  workflow_dispatch:
    inputs:
      velodrome:
        description: 'å¯¾è±¡ç«¶è¼ªå ´ï¼ˆç©ºæ¬„ã§å…¨å ´ï¼‰'
        required: false
        default: ''
        type: string
      demo_mode:
        description: 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆAPIãªã—ã§ãƒ†ã‚¹ãƒˆï¼‰'
        required: false
        type: boolean
        default: false

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
  LINE_USER_ID: ${{ secrets.LINE_USER_ID }}

jobs:
  predict:
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ” Check secrets
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âš ï¸ Warning: GEMINI_API_KEY not set. Running in demo mode."
          fi
          if [ -z "$LINE_CHANNEL_ACCESS_TOKEN" ]; then
            echo "âš ï¸ Warning: LINE_CHANNEL_ACCESS_TOKEN not set."
          fi
      
      - name: ğŸš´ Run morning job
        run: |
          cd src
          
          ARGS="morning"
          
          # ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
          if [ "${{ github.event.inputs.demo_mode }}" = "true" ] || [ -z "$GEMINI_API_KEY" ]; then
            ARGS="$ARGS --demo"
            echo "Running in demo mode"
          fi
          
          # ç«¶è¼ªå ´æŒ‡å®š
          if [ -n "${{ github.event.inputs.velodrome }}" ]; then
            ARGS="$ARGS --velodrome '${{ github.event.inputs.velodrome }}'"
          fi
          
          echo "Executing: python bot.py $ARGS"
          python bot.py $ARGS
      
      - name: ğŸ’¾ Commit data changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Morning job - $(date +'%Y-%m-%d %H:%M') JST"
          fi
      
      - name: ğŸš€ Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
